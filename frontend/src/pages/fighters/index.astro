---
import Layout from '../../layouts/Layout.astro';
import { supabase } from '../../lib/supabase';
import FilterDropdown from '../../components/FilterDropdown.astro';

// Define interfaces and get data (this part remains unchanged)
interface Fighter {
  id: string;
  name: string;
  weight_class: string | null | undefined;
  nationality: string | null;
  wins: number | null;
  losses: number | null;
  draws: number | null;
  rank: string | null;
  status: string | null;
  no_contests: number | null;
}

interface FilterOption {
  value: string;
  label: string;
}

const {
  data: allFighters,
  error,
  count,
} = await supabase
  .from('fighters')
  .select(
    'id, name, weight_class, nationality, wins, losses, draws, rank, status, no_contests',
    { count: 'exact' },
  )
  .order('name', { ascending: true })
  .range(0, 9); // Get first 10 (0-9)

// Get all unique nationalities from the database
const { data: nationalityData } = await supabase
  .from('fighters')
  .select('nationality')
  .not('nationality', 'is', null);

// Get all unique weight classes from the database
const { data: weightClassData } = await supabase
  .from('fighters')
  .select('weight_class')
  .not('weight_class', 'is', null);

// Get fighters list for display
const fightersList = (allFighters as Fighter[]) || [];
const totalFighters = count || 0;

// Weight class ordering (unchanged)
const weightClassOrderMap: Record<string, number> = {
  // Men's divisions (lightest to heaviest)
  Flyweight: 1,
  Bantamweight: 2,
  Featherweight: 3,
  Lightweight: 4,
  Welterweight: 5,
  Middleweight: 6,
  'Light Heavyweight': 7,
  Heavyweight: 8,

  // Women's divisions (lightest to heaviest)
  "Women's Strawweight": 9,
  "Women's Flyweight": 10,
  "Women's Bantamweight": 11,
  "Women's Featherweight": 12,
};

// Extract all unique weight classes from the database
const weightClasses = Array.from(
  new Set(
    (weightClassData || []).map(item => item.weight_class).filter(Boolean),
  ),
)
  .filter((wc): wc is string => Boolean(wc))
  .sort((a, b) => {
    // Check if weight classes exist in our order map
    const aExists = a in weightClassOrderMap;
    const bExists = b in weightClassOrderMap;

    // If both weight classes are in our order list, sort by their position
    if (aExists && bExists) {
      return weightClassOrderMap[a] - weightClassOrderMap[b];
    }

    // If only one is in our order list, prioritize the known one
    if (aExists) return -1;
    if (bExists) return 1;

    // If neither is in our list, sort alphabetically as fallback
    return a.localeCompare(b);
  });

// Extract all unique nationalities from the database
const nationalities = Array.from(
  new Set(
    (nationalityData || []).map(item => item.nationality).filter(Boolean),
  ),
).sort();

// Initial visible batch of fighters (unchanged)
const initialVisible = 10;

// JSON stringify the fighters data to pass to client (unchanged)
const fightersData = JSON.stringify(fightersList);

// Create filter options for dropdowns (CHANGED: combined Retired and Not Fighting)
const statusOptions: FilterOption[] = [
  { value: '', label: 'All' },
  { value: 'Active', label: 'Active' },
  { value: 'Retired', label: 'Retired' },
];

const championOptions: FilterOption[] = [
  { value: '', label: 'All' },
  { value: 'champion', label: 'Champions Only' },
];

const weightClassOptions: FilterOption[] = [
  { value: '', label: 'All' },
  ...weightClasses.map(wc => ({
    value: wc || '',
    label: wc || 'Unknown',
  })),
];

// Convert nationalities from string[] to FilterOption[] (unchanged)
const nationalityOptions: FilterOption[] = [
  { value: '', label: 'All' },
  ...nationalities.map(nat => ({
    value: nat || '',
    label: nat || 'Unknown',
  })),
];
---

<Layout title="UFC Fighters">
  <main class="fighters-page">
    <section class="fighters-container">
      <h1>UFC Fighters</h1>

      <div class="filters-section">
        <div class="search-container">
          <input
            type="text"
            id="fighter-search"
            class="search-input"
            placeholder="Search fighter name..."
            autocomplete="off"
          />
          <button
            id="clear-search"
            class="clear-search-button"
            style="display: none;">×</button
          >
        </div>

        <div class="filters-container">
          <!-- Hidden original selects for JS compatibility -->
          <select id="status-filter" class="filter-select hidden-select">
            <option value="">All Statuses</option>
            <option value="Active">Active</option>
            <option value="Retired">Retired</option>
          </select>

          <select id="champion-filter" class="filter-select hidden-select">
            <option value="">All Fighters</option>
            <option value="champion">Champions Only</option>
          </select>

          <select id="weight-class-filter" class="filter-select hidden-select">
            <option value="">All Weight Classes</option>
            {
              weightClasses.map(weightClass => (
                <option value={weightClass || ''}>
                  {weightClass || 'Unknown'}
                </option>
              ))
            }
          </select>

          <select id="nationality-filter" class="filter-select hidden-select">
            <option value="">All Nationalities</option>
            {
              nationalities.map(nationality => (
                <option value={nationality || ''}>
                  {nationality || 'Unknown'}
                </option>
              ))
            }
          </select>

          <!-- Custom filter dropdowns with grid layout -->
          <div class="custom-filters">
            <FilterDropdown
              label="Status"
              options={statusOptions}
              currentValue=""
              id="status-filter"
            />

            <FilterDropdown
              label="Champion"
              options={championOptions}
              currentValue=""
              id="champion-filter"
            />

            <FilterDropdown
              label="Weight Class"
              options={weightClassOptions}
              currentValue=""
              id="weight-class-filter"
            />

            <FilterDropdown
              label="Nationality"
              options={nationalityOptions}
              currentValue=""
              id="nationality-filter"
            />

            <button id="reset-filters" class="reset-button"
              >Reset Filters</button
            >
          </div>
        </div>
      </div>

      <!-- Added: Selected filters pool -->
      <div id="selected-filters-pool" class="selected-filters-pool"></div>

      <div class="fighters-grid" id="fighters-grid">
        {
          fightersList.slice(0, initialVisible).map(fighter => (
            <a
              href={`/fighters/${fighter.id}`}
              class="fighter-card"
              data-weight-class={fighter.weight_class || ''}
              data-nationality={fighter.nationality || ''}
              data-status={fighter.status || ''}
              data-rank={fighter.rank || ''}
            >
              <div class="fighter-header">
                <h2>{fighter.name}</h2>
                {fighter.rank === 'Champion' ? (
                  <span class="champion-badge">Champion</span>
                ) : fighter.status === 'Active' ? (
                  <span class="active-badge">Active</span>
                ) : fighter.status === 'Retired' ||
                  fighter.status === 'Not Fighting' ? (
                  <span class="retired-badge">Retired</span>
                ) : null}
              </div>
              <div class="fighter-details">
                {fighter.weight_class && (
                  <p class="fighter-weight-class">{fighter.weight_class}</p>
                )}
                <div class="fighter-record">
                  <span class="record-value">
                    {fighter.wins || 0}-{fighter.losses || 0}-{fighter.draws || 0}
                  </span>
                  <span class="record-label">W-L-D</span>
                  <span class="record-nc">
                    {(fighter.no_contests ?? 0) > 0
                      ? `${fighter.no_contests} NC`
                      : ''}
                  </span>
                </div>
                {fighter.rank &&
                  fighter.rank !== 'NR' &&
                  fighter.rank !== 'Unranked' && (
                    <div class="fighter-rank">Rank: {fighter.rank}</div>
                  )}
                {fighter.nationality && (
                  <p class="fighter-nationality">{fighter.nationality}</p>
                )}
              </div>
            </a>
          ))
        }
      </div>

      <div id="no-results" class="no-results" style="display: none;">
        <p>
          No fighters match your current filters. Try adjusting your criteria.
        </p>
      </div>

      <div class="load-more-container">
        <button
          id="load-more"
          class="load-more-button"
          data-current-count={initialVisible}
        >
          Load More Fighters
        </button>
        <p class="fighters-count">
          Showing <span id="shown-count"
            >{Math.min(initialVisible, fightersList.length)}</span
          > of <span id="total-count">{totalFighters}</span> fighters
          <span id="filtered-text" style="display: none;"> (filtered)</span>
        </p>
      </div>
      <div id="fighters-data" style="display: none;">{fightersData}</div>
    </section>
  </main>
</Layout>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    import('../../utils/analytics.ts').then(({ trackEvent }) => {
      // Track page view
      trackEvent('view_fighters_list', {
        event_category: 'Page View',
        event_label: 'UFC Fighters Listing'
      });

      // Track searches - with proper TypeScript types
      const searchInput = document.getElementById('fighter-search') as HTMLInputElement | null;
      let previousSearch = '';
      
      if (searchInput) {
        searchInput.addEventListener('blur', () => {
          const currentSearch = searchInput.value.trim().toLowerCase();
          // Only track if search term is different and not empty
          if (currentSearch && currentSearch !== previousSearch) {
            trackEvent('search_fighters', {
              event_category: 'Search',
              event_label: currentSearch,
              search_term: currentSearch
            });
            previousSearch = currentSearch;
          }
        });
      }

      // Track filter usage - with proper TypeScript types
      const statusFilter = document.getElementById('status-filter') as HTMLSelectElement | null;
      const championFilter = document.getElementById('champion-filter') as HTMLSelectElement | null;
      
      if (statusFilter) {
        statusFilter.addEventListener('change', function() {
          if (this.value) {
            trackEvent('filter_fighters', {
              event_category: 'Filter',
              event_label: `Status: ${this.value}`,
              filter_type: 'status',
              filter_value: this.value
            });
          }
        });
      }
      
      if (championFilter) {
        championFilter.addEventListener('change', function() {
          if (this.value) {
            trackEvent('filter_fighters', {
              event_category: 'Filter',
              event_label: 'Champions Only',
              filter_type: 'champion',
              filter_value: this.value
            });
          }
        });
      }
      
      // Track weight class filter selection
      document.querySelectorAll('#weight-class-filter-dropdown .filter-item').forEach(item => {
        item.addEventListener('click', function(this: HTMLElement) {
          const value = this.getAttribute('data-value');
          if (value && value !== '') {
            trackEvent('filter_fighters', {
              event_category: 'Filter',
              event_label: `Weight Class: ${value}`,
              filter_type: 'weight_class',
              filter_value: value
            });
          }
        });
      });
      
      // Track nationality filter selection
      document.querySelectorAll('#nationality-filter-dropdown .filter-item').forEach(item => {
        item.addEventListener('click', function(this: HTMLElement) {
          const value = this.getAttribute('data-value');
          if (value && value !== '') {
            trackEvent('filter_fighters', {
              event_category: 'Filter',
              event_label: `Nationality: ${value}`,
              filter_type: 'nationality',
              filter_value: value
            });
          }
        });
      });
      
      // Track filter reset
      const resetButton = document.getElementById('reset-filters');
      if (resetButton) {
        resetButton.addEventListener('click', () => {
          trackEvent('reset_filters', {
            event_category: 'Filter',
            event_label: 'Reset All Filters'
          });
        });
      }
      
      // Track load more clicks
      const loadMoreButton = document.getElementById('load-more') as HTMLButtonElement | null;
      if (loadMoreButton) {
        loadMoreButton.addEventListener('click', () => {
          const currentCount = parseInt(loadMoreButton.getAttribute('data-current-count') || '10');
          trackEvent('load_more_fighters', {
            event_category: 'Navigation',
            event_label: `Loaded ${currentCount} more fighters`,
            current_count: currentCount
          });
        });
      }
      
      // Track fighter card clicks with proper TypeScript handling
      document.addEventListener('click', (event) => {
        if (!event.target) return;
        
        // Use type assertion to tell TypeScript that event.target is an Element
        const target = event.target as Element;
        const fighterCard = target.closest('.fighter-card') as HTMLAnchorElement | null;
        
        if (fighterCard) {
          const fighterPath = fighterCard.getAttribute('href');
          const fighterId = fighterPath ? fighterPath.split('/').pop() || '' : '';
          const fighterName = fighterCard.querySelector('h2')?.textContent || 'Unknown Fighter';
          const weightClass = fighterCard.dataset.weightClass || 'Unknown';
          const nationality = fighterCard.dataset.nationality || 'Unknown';
          
          trackEvent('select_fighter', {
            event_category: 'Navigation',
            event_label: fighterName,
            fighter_id: fighterId,
            fighter_name: fighterName,
            weight_class: weightClass,
            nationality: nationality
          });
        }
      }, true);
    }).catch(err => {
      console.error('Error loading analytics:', err);
    });
  });
</script>

<script is:inline>
  document.addEventListener('DOMContentLoaded', () => {
    // Elements for searching
    const searchInput = document.getElementById('fighter-search');
    const clearSearchBtn = document.getElementById('clear-search');

    // Filter elements
    const statusFilter = document.getElementById('status-filter');
    const championFilter = document.getElementById('champion-filter');
    const resetFiltersButton = document.getElementById('reset-filters');
    const selectedFiltersPool = document.getElementById(
      'selected-filters-pool',
    );

    // Display elements
    const loadMoreButton = document.getElementById('load-more');
    const fightersGrid = document.getElementById('fighters-grid');
    const shownCountSpan = document.getElementById('shown-count');
    const totalCountSpan = document.getElementById('total-count');
    const filteredTextSpan = document.getElementById('filtered-text');
    const noResultsDiv = document.getElementById('no-results');

    // Parse fighters data from server
    const initialFighters = JSON.parse(
      document.getElementById('fighters-data').textContent,
    );

    // Get the total count from the server-side rendered value
    const totalFightersFromServer = parseInt(totalCountSpan.textContent);

    // Initialize fighters lists
    let allFighters = [...initialFighters];
    let visibleCount = parseInt(
      loadMoreButton.getAttribute('data-current-count') || '10',
    );

    // Search term variable
    let searchTerm = '';

    // Track multi-select filters
    const selectedNationalities = new Set();
    const selectedWeightClasses = new Set();

    // Track if there's a request in progress
    let isSearching = false;

    // Debounce helper function
    function debounce(func, delay) {
      let timeoutId;
      return function (...args) {
        clearTimeout(timeoutId);
        timeoutId = setTimeout(() => {
          func.apply(this, args);
        }, delay);
      };
    }

    if (searchInput) {
      searchInput.addEventListener('input', function (e) {
        // Get current input and cursor position
        let currentValue = this.value;
        const cursorPos = this.selectionStart;

        // Only allow letters and a single space between words
        let sanitized = currentValue.replace(/[^a-zA-Z ]/g, ''); // Only letters and spaces

        // Handle multiple spaces - convert to single space
        sanitized = sanitized.replace(/\s{2,}/g, ' ');

        // If the value changed after sanitization, update the input
        if (sanitized !== currentValue) {
          this.value = sanitized;
          // Adjust cursor position
          this.setSelectionRange(
            Math.min(cursorPos, sanitized.length),
            Math.min(cursorPos, sanitized.length),
          );
        }

        // Only search if 3+ characters or empty
        if (sanitized.length >= 3 || sanitized.length === 0) {
          searchTerm = sanitized.toLowerCase();

          // Show/hide clear button
          clearSearchBtn.style.display = searchTerm ? 'flex' : 'none';

          // Debounce the API call to not spam the server while typing
          debouncedSearch();
        }
      });

      // Create debounced search function
      const debouncedSearch = debounce(() => {
        // Reset visible count and reload fighters
        visibleCount = 10;
        allFighters = [];
        applyFilters();
      }, 300);
    }

    // Clear search button
    if (clearSearchBtn) {
      clearSearchBtn.addEventListener('click', function () {
        searchInput.value = '';
        searchTerm = '';
        this.style.display = 'none';
        // Reset visible count and reload fighters
        visibleCount = 10;
        allFighters = [];
        applyFilters();
      });
    }

    // Main function to fetch and filter fighters
    async function applyFilters(isLoadMore = false) {
      // Prevent multiple simultaneous requests
      if (isSearching) return;

      isSearching = true;
      const status = statusFilter.value;
      const isChampion = championFilter.value === 'champion';

      // Update filter tags
      updateFilterTags(status, isChampion, searchTerm);

      // Show loading state in the grid
      if (!isLoadMore) {
        fightersGrid.innerHTML =
          '<div class="loading-indicator" style="text-align: center; padding: 2rem;">Loading fighters...</div>';
      } else {
        // For load more, just show loading in the button
        loadMoreButton.innerText = 'Loading...';
        loadMoreButton.disabled = true;
      }

      try {
        // Build query params for API request
        const params = new URLSearchParams();

        // Add pagination params - always 10 per batch, except for last batch
        params.append(
          'offset',
          isLoadMore ? allFighters.length.toString() : '0',
        );

        const totalFighters = parseInt(totalCountSpan.textContent);
        const remainingFighters = totalFighters - allFighters.length;

        // Always load 10 fighters per batch, unless less than 10 remain
        if (isLoadMore && remainingFighters > 0 && remainingFighters < 10) {
          params.append('limit', remainingFighters.toString());
        } else {
          params.append('limit', '10'); // Standard batch size
        }

        // Add filters
        if (searchTerm) {
          params.append('search', searchTerm);
        }

        if (status) {
          params.append('status', status);
        }

        if (isChampion) {
          params.append('champion', 'true');
        }

        // Add multi-select filters as array params
        if (selectedWeightClasses.size > 0) {
          selectedWeightClasses.forEach(wc => {
            params.append('weightClass', wc);
          });
        }

        if (selectedNationalities.size > 0) {
          selectedNationalities.forEach(nat => {
            params.append('nationality', nat);
          });
        }

        // Fetch fighters with applied filters
        const response = await fetch(`/api/fighters?${params.toString()}`);

        if (!response.ok) {
          throw new Error(`Failed to fetch fighters: ${response.status}`);
        }

        const data = await response.json();

        // Update fighters data
        if (!isLoadMore) {
          // Replace all fighters if this is a new filter
          allFighters = data.fighters || [];
        } else {
          // Append fighters if loading more
          if (data.fighters && data.fighters.length > 0) {
            allFighters = [...allFighters, ...data.fighters];
          }
        }

        // Update count display - this is important to get the total for the current filters
        totalCountSpan.textContent =
          data.count !== undefined
            ? data.count.toString()
            : totalFightersFromServer.toString();

        // Clear the grid if not loading more
        if (!isLoadMore) {
          fightersGrid.innerHTML = '';
        }

        // Update UI
        updateFightersDisplay();

        // Update dropdown displays
        updateDropdownDisplays();
      } catch (error) {
        console.error('Error applying filters:', error);
        // Clear the grid and show error
        if (!isLoadMore) {
          fightersGrid.innerHTML = `
            <div class="error" style="text-align: center; padding: 2rem; color: #ff4444;">
              Error loading fighters. Please try again.
            </div>
          `;
        } else {
          loadMoreButton.innerText = 'Error - Try Again';
        }
      } finally {
        isSearching = false;
        if (isLoadMore) {
          loadMoreButton.disabled = false;
          loadMoreButton.innerText = 'Load More Fighters';
        }
      }
    }

    function updateFilterTags(status, isChampion, search) {
      // Clear existing tags
      selectedFiltersPool.innerHTML = '';

      // Add search tag if applicable with title case
      if (search) {
        // Convert to title case
        const titleCased = search
          .split(' ')
          .map(word => word.charAt(0).toUpperCase() + word.slice(1))
          .join(' ');

        addFilterTag('search', search, `Search: ${titleCased}`);
      }

      // Rest of filter tags logic
      if (status) {
        addFilterTag('status', status, status);
      }

      if (isChampion) {
        addFilterTag('champion', 'champion', 'Champions Only');
      }

      selectedWeightClasses.forEach(weightClass => {
        addFilterTag('weight-class', weightClass, weightClass);
      });

      selectedNationalities.forEach(nationality => {
        addFilterTag('nationality', nationality, nationality);
      });
    }

    // Function to add a filter tag
    function addFilterTag(type, value, label) {
      const filterTag = document.createElement('div');
      filterTag.className = `filter-tag ${type}`;
      filterTag.dataset.value = value;
      filterTag.innerHTML = `
        ${label}
        <span class="filter-tag-remove">×</span>
      `;

      // Add click handler to remove tag
      filterTag
        .querySelector('.filter-tag-remove')
        .addEventListener('click', () => {
          removeFilter(type, value);
        });

      selectedFiltersPool.appendChild(filterTag);
    }

    // Function to remove a filter
    function removeFilter(type, value) {
      switch (type) {
        case 'search':
          searchInput.value = '';
          searchTerm = '';
          clearSearchBtn.style.display = 'none';
          break;
        case 'status':
          statusFilter.value = '';
          break;
        case 'champion':
          championFilter.value = '';
          break;
        case 'weight-class':
          selectedWeightClasses.delete(value);
          break;
        case 'nationality':
          selectedNationalities.delete(value);
          break;
      }

      // When removing a filter, reset to first batch
      visibleCount = 10;
      allFighters = [];
      applyFilters();
    }

    // Helper function to update dropdown display text
    function updateDropdownText(dropdown, value) {
      if (!dropdown) return;

      const selectedDisplay = dropdown.querySelector('.filter-selected span');
      const menuItems = dropdown.querySelectorAll('.filter-item');

      // Reset active state on all items
      menuItems.forEach(item => {
        item.classList.remove('active');

        if (item.getAttribute('data-value') === value) {
          // Update text display and set this item as active
          selectedDisplay.textContent = item.textContent;
          item.classList.add('active');
        }
      });

      // If no value selected, set to "All"
      if (!value) {
        const defaultItem = dropdown.querySelector(
          '.filter-item[data-value=""]',
        );
        if (defaultItem) {
          selectedDisplay.textContent = defaultItem.textContent;
          defaultItem.classList.add('active');
        }
      }
    }

    // Update all dropdown displays
    function updateDropdownDisplays() {
      const statusDropdown = document.getElementById('status-filter-dropdown');
      const championDropdown = document.getElementById(
        'champion-filter-dropdown',
      );
      const weightClassDropdown = document.getElementById(
        'weight-class-filter-dropdown',
      );
      const nationalityDropdown = document.getElementById(
        'nationality-filter-dropdown',
      );

      // Update the selected text for each dropdown
      updateDropdownText(statusDropdown, statusFilter.value);
      updateDropdownText(championDropdown, championFilter.value);

      // Update multi-select dropdown text
      if (weightClassDropdown) {
        const display = weightClassDropdown.querySelector(
          '.filter-selected span',
        );
        if (selectedWeightClasses.size === 0) {
          display.textContent = 'All';
        } else {
          display.textContent = `${selectedWeightClasses.size} selected`;
        }
      }

      if (nationalityDropdown) {
        const display = nationalityDropdown.querySelector(
          '.filter-selected span',
        );
        if (selectedNationalities.size === 0) {
          display.textContent = 'All';
        } else {
          display.textContent = `${selectedNationalities.size} selected`;
        }
      }
    }

    function updateFightersDisplay() {
      fightersGrid.innerHTML = '';

      if (allFighters.length === 0) {
        noResultsDiv.style.display = 'block';
        loadMoreButton.style.display = 'none';
        return;
      }

      noResultsDiv.style.display = 'none';

      allFighters.forEach(fighter => {
        const fighterCard = document.createElement('a');
        fighterCard.href = `/fighters/${fighter.id}`;
        fighterCard.className = 'fighter-card';
        fighterCard.dataset.weightClass = fighter.weight_class || '';
        fighterCard.dataset.nationality = fighter.nationality || '';
        fighterCard.dataset.status = fighter.status || '';
        fighterCard.dataset.rank = fighter.rank || '';

        const wins = fighter.wins || 0;
        const losses = fighter.losses || 0;
        const draws = fighter.draws || 0;
        const noContests = fighter.no_contests || 0;

        let statusBadgeHTML = '';
        if (fighter.rank === 'Champion') {
          statusBadgeHTML = '<span class="champion-badge">Champion</span>';
        } else if (fighter.status === 'Active') {
          statusBadgeHTML = '<span class="active-badge">Active</span>';
        } else if (
          fighter.status === 'Retired' ||
          fighter.status === 'Not Fighting'
        ) {
          statusBadgeHTML = '<span class="retired-badge">Retired</span>';
        }

        fighterCard.innerHTML = `
          <div class="fighter-header">
            <h2>${fighter.name}</h2>
            ${statusBadgeHTML}
          </div>
          <div class="fighter-details">
            ${fighter.weight_class ? `<p class="fighter-weight-class">${fighter.weight_class}</p>` : ''}
            <div class="fighter-record">
              <span class="record-value">${wins}-${losses}-${draws}</span>
              <span class="record-label">W-L-D</span>
              ${noContests > 0 ? `<span class="record-nc">${noContests} NC</span>` : ''}
            </div>
            ${
              fighter.status !== 'Retired' &&
              fighter.rank &&
              fighter.rank !== 'Champion'
                ? fighter.rank === 'Unranked'
                  ? `<div class="fighter-rank"></div>`
                  : `<div class="fighter-rank">Rank: ${fighter.rank}</div>`
                : ''
            }
            ${
              fighter.nationality
                ? `<p class="fighter-nationality">${fighter.nationality}</p>`
                : ''
            }
          </div>
        `;

        fightersGrid.appendChild(fighterCard);
      });

      shownCountSpan.textContent = allFighters.length.toString();

      const isFiltered =
        searchTerm ||
        statusFilter.value ||
        championFilter.value ||
        selectedWeightClasses.size > 0 ||
        selectedNationalities.size > 0;

      filteredTextSpan.style.display = isFiltered ? 'inline' : 'none';

      const totalFighters = parseInt(totalCountSpan.textContent);
      const hasMoreToLoad = allFighters.length < totalFighters;

      loadMoreButton.style.display = hasMoreToLoad ? 'block' : 'none';
      loadMoreButton.disabled = false;
      loadMoreButton.innerText = 'Load More Fighters';
    }

    if (loadMoreButton) {
      loadMoreButton.addEventListener('click', async () => {
        applyFilters(true);
      });
    }

    if (statusFilter) {
      statusFilter.addEventListener('change', function () {
        visibleCount = 10;
        allFighters = [];
        applyFilters();
      });
    }

    if (championFilter) {
      championFilter.addEventListener('change', function () {
        visibleCount = 10;
        allFighters = [];
        applyFilters();
      });
    }

    if (resetFiltersButton) {
      resetFiltersButton.addEventListener('click', () => {
        searchInput.value = '';
        searchTerm = '';
        clearSearchBtn.style.display = 'none';

        statusFilter.value = '';
        championFilter.value = '';

        selectedNationalities.clear();
        selectedWeightClasses.clear();

        selectedFiltersPool.innerHTML = '';

        visibleCount = 10;
        allFighters = [];
        applyFilters();
      });
    }

    document.querySelectorAll('.filter-dropdown').forEach(dropdown => {
      const type = dropdown.id.replace('-filter-dropdown', '');
      const select = document.getElementById(`${type}-filter`);

      if (select) {
        dropdown.querySelectorAll('.filter-item').forEach(item => {
          item.addEventListener('click', function () {
            const value = this.getAttribute('data-value');

            if (type === 'nationality') {
              if (value === '') {
                selectedNationalities.clear();
              } else {
                if (selectedNationalities.has(value)) {
                  selectedNationalities.delete(value);
                } else {
                  selectedNationalities.add(value);
                }
              }
              this.classList.toggle('active', selectedNationalities.has(value));
            } else if (type === 'weight-class') {
              if (value === '') {
                selectedWeightClasses.clear();
              } else {
                if (selectedWeightClasses.has(value)) {
                  selectedWeightClasses.delete(value);
                } else {
                  selectedWeightClasses.add(value);
                }
              }
              this.classList.toggle('active', selectedWeightClasses.has(value));
            } else {
              select.value = value;
              const event = new Event('change');
              select.dispatchEvent(event);
            }

            if (type === 'nationality' || type === 'weight-class') {
              visibleCount = 10;
              allFighters = [];
              applyFilters();
            }
          });
        });
      }
    });

    updateFilterTags('', false, '');
    updateDropdownDisplays();
  });
</script>
