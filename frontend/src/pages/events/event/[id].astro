---
import Layout from '../../../layouts/Layout.astro';
import { supabase } from '../../../lib/supabase';

// Define interfaces for type safety
interface Event {
  id: string;
  name: string;
  event_date: string;
  venue: string | null;
  city: string | null;
  country: string | null;
  status: string;
  ufc_url: string | null;
  attendance: string | null;
}

interface Fighter {
  id: string;
  name: string;
  nickname: string | null;
  weight_class: string | null;
}

interface Fight {
  id: string;
  event_id: string;
  fighter1_id: string;
  fighter2_id: string;
  fighter1_name: string;
  fighter2_name: string;
  fighter1_rank: string | null;
  fighter2_rank: string | null;
  weight_class: string;
  is_main_event: boolean;
  fighter1_was_champion: boolean;
  fighter2_was_champion: boolean;
  was_title_fight: boolean;
  fight_order: number | null;
  winner_id: string | null;
  result_method: string | null;
  result_method_details: string | null;
  result_round: number | null;
  result_time: string | null;
  fighter1: Fighter;
  fighter2: Fighter;
  winner: Fighter | null;
}

// Get the event ID from the URL
const { id } = Astro.params;
const eventId = id;

if (!eventId) {
  return Astro.redirect('/events');
}

// Optimize by combining both queries into a single Supabase call
const [eventResult, fightsResult] = await Promise.all([
  // Query 1: Fetch only needed event fields - added ufc_url to the select
  supabase
    .from('events')
    .select(
      'id, name, event_date, venue, city, country, status, ufc_url, attendance',
    )
    .eq('id', eventId)
    .single(),

  // Query 2: Fetch fights with only needed fighter data
  supabase
    .from('fights')
    .select(
      `
      id, event_id, fighter1_id, fighter2_id, fighter1_name, fighter2_name,
      fighter1_rank, fighter2_rank, weight_class, is_main_event, 
      fighter1_was_champion, fighter2_was_champion, was_title_fight,
      fight_order, winner_id, result_method, result_method_details, 
      result_round, result_time,
      fighter1:fighter1_id(id, name),
      fighter2:fighter2_id(id, name),
      winner:winner_id(id, name)
    `,
    )
    .eq('event_id', eventId)
    .order('fight_order', { ascending: true }),
]);

// Handle potential errors
if (eventResult.error) {
  console.error('Error fetching event:', eventResult.error);
}

if (fightsResult.error) {
  console.error('Error fetching fights:', fightsResult.error);
}

const eventData = eventResult.data as Event | null;

// Fix the TypeScript error with proper type handling
let fightsList: Fight[] = [];
if (fightsResult.data) {
  // Use type assertion with unknown first to fix the TypeScript error
  fightsList = fightsResult.data as unknown as Fight[];
}

// Determine if the event is in the past based on status
const isEventCompleted = eventData?.status === 'Completed';

// Set cache control headers for better performance
// Completed events can be cached longer since they don't change
if (isEventCompleted) {
  Astro.response.headers.set('Cache-Control', 'public, max-age=86400'); // 24 hours
} else {
  Astro.response.headers.set('Cache-Control', 'public, max-age=3600'); // 1 hour
}

const isFightCanceled = (fight: Fight, isCompleted: boolean) => {
  return (
    isCompleted &&
    !fight.winner_id &&
    !fight.result_method &&
    fight.result_method !== 'Draw' &&
    fight.result_method !== 'No Contest'
  );
};
---

<Layout title={eventData ? eventData.name : 'Event Details'}>
  <main class="event-page">
    {
      eventData ? (
        <div class="event-details-container">
          <div class="event-header">
            <h1>{eventData.name}</h1>

            <a
              href={eventData.ufc_url}
              target="_blank"
              rel="noopener noreferrer"
              class="ufc-link"
            >
              <span class="ufc-icon">UFC</span>
              <span class="link-text">Official Page</span>
            </a>

            <div class="event-meta">
              <div class="event-date-time">
                {(() => {
                  const eventDate = new Date(eventData.event_date);

                  if (isNaN(eventDate.getTime())) {
                    return <div>Date not available</div>;
                  }

                  const formattedDate = eventDate.toLocaleDateString('en-US', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                  });

                  // Format the time in user's local timezone
                  const formattedTime = eventDate.toLocaleTimeString('en-US', {
                    hour: '2-digit',
                    minute: '2-digit',
                    timeZoneName: 'short',
                  });

                  return (
                    <>
                      <div class="event-date">{formattedDate}</div>
                      <div class="event-time">{formattedTime}</div>
                    </>
                  );
                })()}
              </div>
              <div class="event-location">
                {eventData.venue && (
                  <span class="venue">{eventData.venue}</span>
                )}
                {eventData.city && eventData.country && (
                  <span class="location">
                    {eventData.city}, {eventData.country}
                  </span>
                )}
                {eventData.attendance &&
                  isEventCompleted &&
                  parseInt(String(eventData.attendance).replace(/[^\d]/g, '')) >
                    0 && (
                    <span class="attendance">
                      <span class="attendance-icon">ðŸ‘¥</span>
                      <span class="attendance-count">
                        {(() => {
                          // First convert to string to handle any unexpected types
                          const attendanceStr = String(eventData.attendance);
                          // Extract all numeric digits from the string
                          const numericValue = attendanceStr.replace(
                            /[^\d]/g,
                            '',
                          );
                          // Parse as integer and format with commas
                          const formattedAttendance = numericValue
                            ? new Intl.NumberFormat().format(
                                parseInt(numericValue),
                              )
                            : attendanceStr;
                          return `${formattedAttendance} fans`;
                        })()}
                      </span>
                    </span>
                  )}
              </div>
            </div>

            <div class="event-countdown">
              {(() => {
                const eventDate = new Date(eventData.event_date);

                if (isNaN(eventDate.getTime())) {
                  return <div>Date not available</div>;
                }

                const utcYear = eventDate.getUTCFullYear();
                const utcMonth = eventDate.getUTCMonth();
                const utcDay = eventDate.getUTCDate();

                const displayDate = new Date(utcYear, utcMonth, utcDay);

                const today = new Date();
                const todayAtMidnight = new Date(
                  today.getFullYear(),
                  today.getMonth(),
                  today.getDate(),
                );

                const isPastEvent = displayDate < todayAtMidnight;

                const calculateDaysDifference = (
                  date1: Date,
                  date2: Date,
                ): number => {
                  const d1 = new Date(
                    date1.getFullYear(),
                    date1.getMonth(),
                    date1.getDate(),
                  );
                  const d2 = new Date(
                    date2.getFullYear(),
                    date2.getMonth(),
                    date2.getDate(),
                  );

                  const timeDiff = Math.abs(d2.getTime() - d1.getTime());
                  return Math.round(timeDiff / (1000 * 60 * 60 * 24));
                };

                const diffDays = calculateDaysDifference(
                  displayDate,
                  todayAtMidnight,
                );

                let timeDisplay: string;
                if (!isPastEvent) {
                  if (diffDays === 0) {
                    timeDisplay = 'Today';
                  } else if (diffDays === 1) {
                    timeDisplay = 'Tomorrow';
                  } else {
                    timeDisplay = `${diffDays} days until event`;
                  }
                } else {
                  if (diffDays === 0) {
                    timeDisplay = 'Today';
                  } else if (diffDays === 1) {
                    timeDisplay = 'Yesterday';
                  } else {
                    timeDisplay = `${diffDays} days ago`;
                  }
                }

                return (
                  <>
                    <span class="countdown-value">{timeDisplay}</span>
                    <span class="countdown-label">{eventData.status}</span>
                  </>
                );
              })()}
            </div>
          </div>

          <section class="fight-card">
            <h2>Fight Card</h2>

            {fightsList.length > 0 ? (
              <div class="fights-list">
                {fightsList.map(fight => {
                  // Determine if fight was canceled
                  const isCanceled = isFightCanceled(fight, isEventCompleted);

                  return (
                    <div
                      class={`fight ${fight.is_main_event ? 'main-event' : ''} ${fight.was_title_fight ? 'title-fight' : ''} ${isCanceled ? 'canceled-fight' : ''}`}
                    >
                      <div>
                        {fight.is_main_event && (
                          <span class="main-event-tag">Main Event</span>
                        )}
                        {fight.was_title_fight && (
                          <span class="title-fight-tag">Title Fight</span>
                        )}
                        {isCanceled && (
                          <span class="canceled-tag">Canceled</span>
                        )}

                        <span class="weight-class">
                          {fight.weight_class}
                          {fight.was_title_fight && ' Championship'}
                        </span>
                      </div>

                      <div class="fighters">
                        <a
                          href={`/fighters/${fight.fighter1.id}`}
                          class={`fighter fighter-1 
    ${fight.winner_id === fight.fighter1_id ? 'winner' : ''} 
    ${fight.result_method === 'Draw' ? 'draw' : ''} 
    ${fight.result_method === 'No Contest' ? 'no-contest' : ''} 
    ${isCanceled ? 'canceled' : ''}`}
                        >
                          <div class="fighter-name">
                            <span class="name">{fight.fighter1.name}</span>
                          </div>
                          <div class="fighter-status">
                            {/* If they were champion, show champion badge */}
                            {fight.fighter1_was_champion ? (
                              <div class="champion-badge">C</div>
                            ) : fight.fighter1_rank &&
                              fight.fighter1_rank !== 'NR' ? (
                              /* If they had a rank, show it */
                              <div class="fighter-rank">
                                #{fight.fighter1_rank}
                              </div>
                            ) : (
                              /* Only show Unranked if the other fighter has a rank or is champion */
                              (fight.fighter2_was_champion ||
                                (fight.fighter2_rank &&
                                  fight.fighter2_rank !== 'NR')) && (
                                <div class="fighter-unranked">Unranked</div>
                              )
                            )}
                          </div>
                        </a>
                        <div class="vs">VS</div>
                        <a
                          href={`/fighters/${fight.fighter2.id}`}
                          class={`fighter fighter-2 
    ${fight.winner_id === fight.fighter2_id ? 'winner' : ''}
    ${fight.result_method === 'Draw' ? 'draw' : ''} 
    ${fight.result_method === 'No Contest' ? 'no-contest' : ''}
    ${isCanceled ? 'canceled' : ''}`}
                        >
                          <div class="fighter-name">
                            <span class="name">{fight.fighter2.name}</span>
                          </div>
                          <div class="fighter-status">
                            {/* If they were champion, show champion badge */}
                            {fight.fighter2_was_champion ? (
                              <div class="champion-badge">C</div>
                            ) : fight.fighter2_rank &&
                              fight.fighter2_rank !== 'NR' ? (
                              /* If they had a rank, show it */
                              <div class="fighter-rank">
                                #{fight.fighter2_rank}
                              </div>
                            ) : (
                              /* Only show Unranked if the other fighter has a rank or is champion */
                              (fight.fighter1_was_champion ||
                                (fight.fighter1_rank &&
                                  fight.fighter1_rank !== 'NR')) && (
                                <div class="fighter-unranked">Unranked</div>
                              )
                            )}
                          </div>
                        </a>
                      </div>

                      {/* Show fight result if the event is completed */}
                      {isEventCompleted && (
                        <>
                          {isCanceled ? (
                            <div class="fight-result canceled-result">
                              <div class="result-header">Fight Canceled</div>
                            </div>
                          ) : fight.winner_id ? (
                            <div class="fight-result">
                              <div class="result-header">
                                <span class="winner-name">
                                  {fight.winner?.name}
                                </span>{' '}
                                wins by{' '}
                                <span class="method">
                                  {fight.result_method}
                                  {fight.result_method_details &&
                                    ` (${fight.result_method_details})`}
                                </span>
                              </div>
                              {(fight.result_round || fight.result_time) && (
                                <div class="result-timing">
                                  {fight.result_round &&
                                    `Round ${fight.result_round}`}
                                  {fight.result_round &&
                                    fight.result_time &&
                                    ` â€¢ `}
                                  {fight.result_time &&
                                    (() => {
                                      const timeStr = fight.result_time;
                                      const halfLength = timeStr.length / 2;
                                      const firstHalf = timeStr.substring(
                                        0,
                                        halfLength,
                                      );
                                      const secondHalf =
                                        timeStr.substring(halfLength);
                                      return firstHalf === secondHalf
                                        ? firstHalf
                                        : timeStr;
                                    })()}
                                </div>
                              )}
                            </div>
                          ) : fight.result_method === 'Draw' ? (
                            <div class="fight-result draw-result">
                              <div class="result-header">
                                <span class="method">
                                  {fight.result_method}
                                </span>
                              </div>
                              {(fight.result_round || fight.result_time) && (
                                <div class="result-timing">
                                  {fight.result_round &&
                                    `Round ${fight.result_round}`}
                                  {fight.result_round &&
                                    fight.result_time &&
                                    ` â€¢ `}
                                  {fight.result_time &&
                                    (() => {
                                      const timeStr = fight.result_time;
                                      const halfLength = timeStr.length / 2;
                                      const firstHalf = timeStr.substring(
                                        0,
                                        halfLength,
                                      );
                                      const secondHalf =
                                        timeStr.substring(halfLength);

                                      return firstHalf === secondHalf
                                        ? firstHalf
                                        : timeStr;
                                    })()}
                                </div>
                              )}
                            </div>
                          ) : fight.result_method === 'No Contest' ? (
                            <div class="fight-result no-contest-result">
                              <div class="result-header">
                                <span class="method">
                                  {fight.result_method}
                                </span>
                              </div>
                              {(fight.result_round || fight.result_time) && (
                                <div class="result-timing">
                                  {fight.result_round &&
                                    `Round ${fight.result_round}`}
                                  {fight.result_round &&
                                    fight.result_time &&
                                    ` â€¢ `}
                                  {fight.result_time &&
                                    (() => {
                                      const timeStr = fight.result_time;
                                      const halfLength = timeStr.length / 2;
                                      const firstHalf = timeStr.substring(
                                        0,
                                        halfLength,
                                      );
                                      const secondHalf =
                                        timeStr.substring(halfLength);

                                      return firstHalf === secondHalf
                                        ? firstHalf
                                        : timeStr;
                                    })()}
                                </div>
                              )}
                            </div>
                          ) : null}
                        </>
                      )}
                    </div>
                  );
                })}
              </div>
            ) : (
              <div class="no-fights">
                <p>No fights announced yet for this event.</p>
              </div>
            )}
          </section>
        </div>
      ) : (
        <div class="event-not-found">
          <h1>Event Not Found</h1>
          <p>
            Sorry, the event you're looking for doesn't exist or has been
            removed.
          </p>
          <a href="/events" class="back-button">
            Back to Events
          </a>
        </div>
      )
    }
  </main>
</Layout>

<script>
  // Client-side caching for this event page
  document.addEventListener('DOMContentLoaded', () => {
    // Store this page in the browser's cache (sessionStorage)
    // This helps with back-button navigation performance
    const currentUrl = window.location.pathname;
    const eventId = currentUrl.split('/').pop();

    if (eventId) {
      // Generate a key for this event page
      const cacheKey = `event-page-${eventId}`;

      // Don't cache if this is a POST request or form submission
      if (window.performance && window.performance.navigation.type !== 1) {
        // Store current page HTML (for quick back button navigation)
        try {
          sessionStorage.setItem(cacheKey, document.documentElement.outerHTML);
          sessionStorage.setItem(
            `${cacheKey}-timestamp`,
            Date.now().toString(),
          );
        } catch (e) {
          // Storage might be full, handle gracefully
          console.warn('Could not cache page:', e);
        }
      }
    }

    // Preconnect to the API domain for fighter page navigation
    const preconnect = document.createElement('link');
    preconnect.rel = 'preconnect';
    preconnect.href = window.location.origin;
    document.head.appendChild(preconnect);

    // Prefetch the events list page for when users go back
    const prefetch = document.createElement('link');
    prefetch.rel = 'prefetch';
    prefetch.href = '/events';
    document.head.appendChild(prefetch);

    // Preload fighter data for fighters in this event
    const fighterLinks = document.querySelectorAll('.fighter');
    if (fighterLinks.length > 0) {
      // Only preload the main event fighters
      const mainEventLinks = document.querySelectorAll('.main-event .fighter');
      if (mainEventLinks.length > 0) {
        mainEventLinks.forEach(link => {
          if (link instanceof HTMLAnchorElement) {
            const prefetchLink = document.createElement('link');
            prefetchLink.rel = 'prefetch';
            prefetchLink.href = link.href;
            document.head.appendChild(prefetchLink);
          }
        });
      }
    }
  });
</script>
